#!/bin/bash
#
#
case "$DRIVER" in

  nvidia)
    #
    # Repair GL on the intel display
    #
    if $IS_64 ; then
        if [ $(ls /usr/X11R6/lib/libGL.* 2> /dev/null | wc -l) -gt 0 ] ; then
            #
            # Move conflicting i686 NVidia libraries to a safer place.
            #
            rm -rf /usr/X11R6/lib-nvidia
            mkdir -p /usr/X11R6/lib-nvidia
            mv -f /usr/X11R6/lib/libGL.* /usr/X11R6/lib-nvidia/
        fi
        if [ $(ls /usr/X11R6/lib64/libGL.* 2> /dev/null | wc -l) -gt 0 ] ; then
            #
            # Move conflicting x86_64 NVidia libraries to a safer place.
            #
            rm -rf /usr/X11R6/lib64-nvidia
            mkdir -p /usr/X11R6/lib64-nvidia
            mv -f /usr/X11R6/lib64/libGL.* /usr/X11R6/lib64-nvidia/
            mv -f /usr/X11R6/lib64/libXvMCNVIDIA* /usr/X11R6/lib64-nvidia/
        fi
        if [ -f /usr/lib64/xorg/modules/updates/drivers/nvidia_drv.so ] ; then
            #
            # Move NVidia xorg modules to a safer place
            #
            rm -rf /usr/lib64/xorg-nvidia
            cp -a /usr/lib64/xorg /usr/lib64/xorg-nvidia
            rm -f /usr/lib64/xorg/modules/updates/drivers/nvidia_drv.so
            rm -f /usr/lib64/xorg/modules/updates/extensions/libglx.*
        fi
    else
        if [ $(ls /usr/X11R6/lib/libGL.* 2> /dev/null | wc -l) -gt 0 ] ; then
            #
            # Move conflicting NVidia libraries to a safer place.
            #
            rm -rf /usr/X11R6/lib-nvidia
            mkdir -p /usr/X11R6/lib-nvidia
            mv -f /usr/X11R6/lib/libGL.* /usr/X11R6/lib-nvidia/
            mv -f /usr/X11R6/lib/libXvMCNVIDIA* /usr/X11R6/lib-nvidia/
        fi
        if [ -f /usr/lib/xorg/modules/updates/drivers/nvidia_drv.so ] ; then
            #
            # Move NVidia xorg modules to a safer place
            #
            rm -rf /usr/lib/xorg-nvidia
            cp -a /usr/lib/xorg /usr/lib/xorg-nvidia
            rm -f /usr/lib/xorg/modules/updates/drivers/nvidia_drv.so
            rm -f /usr/lib/xorg/modules/updates/extensions/libglx.*
        fi
    fi
    ;;

  nouveau)
    #
    # Nothing to do
    #
    ;;

esac

if [[ ! -n "$DESTDIR" ]] ; then
    #
    # Start the bumblebee service on boot
    #
    chkconfig bumblebee on

    #
    # Start the bumblebee daemon
    #
    /etc/init.d/bumblebee start || true
fi
