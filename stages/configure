#!/bin/bash
# Beware: this file is processed by stages/buildfiles

# check if nouveau is not blacklisted or commented
if grep -rqE "^ *blacklist +nouveau\b" /etc/modprobe.d; then
    # blacklisted is blacklisted, whether it's done in nouveau-blacklist.conf,
    # blacklist.conf or nvidia.conf (OpenSUSE)
    echo "blacklist nouveau" >> /etc/modprobe.d/nouveau-blacklist.conf
fi

# copied from detectharware, this configure step is supposed to be dynamic...
NVIDIABUSID=$(lspci -d 10de: -n | grep '030[02]:' | cut -d' ' -f1 | tr . :)

re_busid='^( *BusID +")[^"]*'

for driver in nvidia; do
    echo "Setting Bus ID in xorg.conf.$driver..."
    sed -E -i "${CONFDIR}/xorg.conf.$driver" \
        -e "s,${re_busid},\1$NVIDIABUSID,"
done

# add the bumblebee group
if getent group bumblebee >/dev/null; then
    echo "Group 'bumblebee' does already exist"
else
    groupadd bumblebee && echo "Group 'bumblebee' has been added"
fi
