#!/bin/bash
# Beware: this file is processed by stages/buildfiles
# avoid bashism here so it can be inserted straigh away in packaging scripts

# We should not mess too much with blacklisting, we unload the drivers anyway.
blacklist=/etc/modprobe/nouveau-blacklist.conf
# the md5sum of "blacklist nouveau\n"
sum=cddff2da6f6e96b8a48943c8ce62a238
if echo "$sum  $blacklist" | md5sum -c --status 2>/dev/null; then
    rm -f "$blacklist"
fi

# Detect PCI Bus ID of the nVidia card
# -d 10de: shows devices from nvidia only
# 03 is the Display controller class
# 0300 is a VGA compatible controller
# 0302 is a 3D controller
# (information from /usr/share/misc/pci.ids and the manpage of lspci)
NVIDIABUSID=$(lspci -d 10de: -n | grep '030[02]:' | cut -d' ' -f1 | tr . :)

re_busid='^( *BusID +")[^"]*'

# Currently, only the nvidia conffile needs the PCI Bus ID set for Ubuntu and Arch Linux
# Currently, both the nvidia and nouveau conffile need the PCI Bus ID set for openSuSE
if [ -f "${CONFDIR}/xorg.conf.nvidia" ]; then
    echo "Setting Bus ID in xorg.conf.nvidia..."
    sed -E -i "${CONFDIR}/xorg.conf.nvidia" \
        -e "s,${re_busid},\1$NVIDIABUSID,"
fi
if [ -f "${CONFDIR}/xorg.conf.nouveau" ]; then
    echo "Setting Bus ID in xorg.conf.nouveau..."
    sed -E -i "${CONFDIR}/xorg.conf.nouveau" \
        -e "s,${re_busid},\1$NVIDIABUSID,"
fi

# add the bumblebee group
if getent group $BUMBLEBEE_GROUP >/dev/null; then
    echo "Group '$BUMBLEBEE_GROUP' does already exist"
else
    groupadd $BUMBLEBEE_GROUP && echo "Group '$BUMBLEBEE_GROUP' has been added"
fi
