#!/bin/bash

if [ ! -f /tmp/.X1-lock ]; then
 sudo /etc/init.d/bumblebee enable
fi

trap "echo 'Caught Ctrl+C'" INT

source /etc/default/bumblebee

export $VGL_READBACK

vglrun -c $VGL_COMPRESS -d $VGL_DISPLAY -ld /usr/lib/nvidia-current "$@"

if [ "$STOP_SERVICE_ON_EXIT" != "NO" ]; then
 until [ `lsof |grep nvidia |wc -l` -lt 0 ]; do      
  echo "Another bumblebee powered application is running, keeping bumblebee alive."
  sleep 1
 done
 sudo /etc/init.d/bumblebee disable 
fi 
