#!/bin/bash
# Copyright (C) 2011 Bumblebee Project
#
# This file is part of Bumblebee.
#
# Bumblebee is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Bumblebee is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Bumblebee.  If not, see <http://www.gnu.org/licenses/>.

ROOT_UID=0

if grep -iqE 'Ubuntu|Linux Mint|Backtrack 5' /etc/issue; then
    DISTRO=UBUNTU
elif grep -iq "Arch Linux" /etc/issue; then
    DISTRO=ARCHLINUX
fi

if (( EUID != 0 )); then
    echo "You do not have sufficient privileges to configure Bumblebee"
    echo
    if which sudo &>/dev/null; then
        echo "Please run: sudo $0"
    else
        echo "Please run this script as root"
    fi
    echo
    exit 1
fi

# Determine Arch x86_64 or i686
ARCH=`uname -m`

# Get tools location
LSPCI="$(which lspci)"

# Get terminal size
LINES=`stty size | cut -f1 -d' '`
COLUMNS=`stty size | cut -f2 -d' '`

CONFDIR=/etc/bumblebee
NVIDIA_LIBDIR=/usr/lib/nvidia-current

echo
echo "Configuring... Please wait"
echo

NVIDIABUSID=$("$LSPCI" -d 10de: -n | grep '030[02]:' | cut -d' ' -f1 | tr . :)

if [ -z "$NVIDIABUSID" ]; then
    whiptail --msgbox \
" The BusID of the nVidia card can't be determined.\n"\
"You must correct this manually in /etc/bumblebee/xorg.conf.nvidia\n"\
"Please report this problem..\n\n"\
"Press enter to continue." $LINES $COLUMNS
fi

re_busid='^( *BusID +")[^"]*'

for driver in nvidia; do
    echo "Setting Bus ID in xorg.conf.$driver..."
    sed -E -i "$CONFDIR/xorg.conf.$driver" \
        -e "s,${re_busid},\1${NVIDIABUSID},"
done
echo

CONNECTEDMONITOR="UNKNOWN"

if [ "$DISTRO" == "UBUNTU" ] ; then

    query_info=$(LD_LIBRARY_PATH="$NVIDIA_LIBDIR" "$NVIDIA_LIBDIR"/bin/nvidia-xconfig --query-gpu-info)
    if [ $(grep "Display Devices" <<<"$query_info" | cut -d: -f2) -gt 0 ]; then
        CONNECTEDMONITOR=$(grep "Display Device 0" <<< "$query_info " | cut -d\( -f2 | cut -d\) -f1)
    fi

fi

if [ "$CONNECTEDMONITOR" != "CRT-0" ] && [ "$CONNECTEDMONITOR" != "DFP-0" ];then
    LIST_SIZE=$(($LINES - 10))
choice=$(whiptail --nocancel --menu \
" The device for the nVidia monitor could not be detected, please\n"\
"manually choose the device, if your having problems, try another." $LINES $COLUMNS $LIST_SIZE 1 "CRT-0" 2 "DFP-0" 3 "Manually Enter" 3>&1 1>&2 2>&3)
    case "$choice" in
      1)
        CONNECTEDMONITOR="CRT-0"
        ;;
      2)
        CONNECTEDMONITOR="DFP-0"
        ;;
      3)
        CONNECTEDMONITOR=$(whiptail --inputbox " Enter the nVidia connected monitor:" $LINES $COLUMNS 3>&1 1>&2 2>&3)
        ;;
    esac
fi

echo "Setting monitor in xorg.conf.nvidia..."
echo

sed -i "s/\([ \t]*Option[ \t]*\"ConnectedMonitor\"[ \t]*\)".*"/\1\"$CONNECTEDMONITOR\"/g" $CONFDIR/xorg.conf.nvidia

echo "Updating rc.d"
if [ "$DISTRO" == "UBUNTU" ] ; then
    update-rc.d bumblebee defaults
fi
echo

LIST_SIZE=$(($LINES - 10))
choice=$(whiptail --nocancel --menu --default-item 3 \
" The Image Transport is how the images are transferred from the\n"\
"nVidia card to the Intel card, people has different experiences of\n"\
"performance, but just select the default if you are in doubt.\n\n"\
"If you're having problems with proxy, you may try xv instead." $LINES $COLUMNS $LIST_SIZE 1 "PROXY (Default)" 2 "XV" 3>&1 1>&2 2>&3)

case "$choice" in
  1)
    IMAGETRANSPORT="proxy"
    ;;
  2)
    IMAGETRANSPORT="xv"
    ;;
  *)
    IMAGETRANSPORT="proxy"
    ;;
esac

sed -i 's/VGL_COMPRESS.*/VGL_COMPRESS='$IMAGETRANSPORT'/' "$CONFDIR/bumblebee.conf"

#
#    Set userrights
#
if ! grep -q '^bumblebee:' /etc/group; then
    groupadd bumblebee
fi

if [ "$DISTRO" == "UBUNTU" ] && [ -n "$SUDO_USER" ]; then
    gpasswd -a "$SUDO_USER" bumblebee
fi
echo

#
#    That's all folks
#
whiptail --msgbox \
" Bumblebee is now configured.\n\n"\
"If you have any problems, please run bumblebee-bugreport\n\n"\
"Have fun...." $LINES $COLUMNS
