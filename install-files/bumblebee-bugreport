#!/bin/bash

#
# ----------------------------------------------------------------------------
# "THE BEER-WARE LICENSE" (Revision 42):
# <mj@casalogic.dk> wrote this file. As long as you retain this notice you
# can do whatever you want with this stuff. If we meet some day, and you think
# this stuff is worth it, you can buy me a beer in return Martin Juhl
# ----------------------------------------------------------------------------
#

#    This file is part of bumblebee.
#
#    bumblebee is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    bumblebee is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with bumblebee.  If not, see <http://www.gnu.org/licenses/>.
#


ROOT_UID=0

if grep -iqE 'Ubuntu|Linux Mint|Backtrack 5' /etc/issue; then
    DISTRO=UBUNTU
elif grep -iq "Arch Linux" /etc/issue; then
    DISTRO=ARCHLINUX
fi

if (( EUID != 0 )); then
    echo "You do not have sufficient privileges to install Bumblebee"
    echo
    if which sudo; then
        echo "Please run: sudo ./install"
    else
        echo "Please run this script as root"
    fi
    echo
    exit 1
fi

echo
echo "Bug report is being generated"
echo

BUGREPORT_DIR=/tmp/bug-report
BUGREPORT_FILE="$BUGREPORT_DIR"/bumblebee-report

rm -rf "$BUGREPORT_DIR"
mkdir -p "$BUGREPORT_DIR"

cp /var/log/Xorg.* "$BUGREPORT_DIR"
cp /etc/bumblebee/xorg.conf* "$BUGREPORT_DIR"
cp /var/log/bumblebee.* "$BUGREPORT_DIR"
cp /etc/bash.bashrc "$BUGREPORT_DIR"

write() {
    echo "$1" >> "$BUGREPORT_FILE"
    echo >> "$BUGREPORT_FILE"
}

write "Bumblebee Bug Report"

write `cat /etc/bumblebee/bumblebee.conf`

write `cat /etc/issue`

write "uname -a info"
write `uname -a`

write "lspci info"
write `lscpi`

write "ps aux info"
write `ps aux | grep X`

write "library info"

for lib in \
    /usr/lib/nvidia-current \
    /usr/lib32/nvidia-current \
    /usr/lib64/nvidia-current
do
    if [ -d "$lib" ]; then
        write "$lib"
        write `ls -la "$lib"`
fi

write "modules info"
write `lsmod`

write "alternatives info"
write `ls -la /etc/alternatives`

write "dmidecode"

dmidecode --string baseboard-manufacturer >> "$BUGREPORT_FILE"
dmidecode --string baseboard-product-name >> "$BUGREPORT_FILE"
dmidecode --string baseboard-version >> "$BUGREPORT_FILE"
dmidecode --string system-manufacturer >> "$BUGREPORT_FILE"
dmidecode --string system-product-name >> "$BUGREPORT_FILE"
dmidecode --string system-version >> "$BUGREPORT_FILE"

tar zcf $HOME/bumblebee-bugreport-`date +2%3y%m%d_%H%M%S`.tar.gz /tmp/bug-report/

echo "Bug report generated"
echo
echo "The bug report has been saved as "$HOME/bumblebee-bugreport-`date +2%3y%m%d_%H%M%S`.tar.gz
echo "Please create a bugreport on github and email me the bug report along with the"
echo "issue number to bumblebee@lists.launchpad.net"
echo
echo "https://github.com/Bumblebee-Project/Bumblebee/issues"
echo 
echo "This really makes bugfixing much easier for us and faster for you"
echo
echo "Martin Juhl / MrMEEE & The Bumblebee Project Team"
