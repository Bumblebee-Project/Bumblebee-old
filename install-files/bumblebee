#!/bin/bash

# load common library
BUMBLEBEE_LIBDIR=/usr/lib/bumblebee
. "$BUMBLEBEE_LIBDIR/common-functions"

# Full paths to possible optirun binaries
OPTIRUNS=()
OPTIRUNS[0]=$(which optirun)
# provided for backwards compatibility, optirun32 is deprecated in favor of
# optirun32 -32, optirun64 is equal to optirun
OPTIRUNS[1]=$(which optirun32)
OPTIRUNS[2]=$(which optirun64)

# Defaults
BUMBLEBEE_FIFO=/var/run/bumblebee.fifo
DRIVER=nvidia
X_CONFFILE=

X_LD_LIBRARY_PATH=
X_DAEMON=$(which X)

# Load settings
. "$BUMBLEBEE_CONFDIR/bumblebee.conf"

# allow the user to specify a custom xorg path, otherwise base on driver
[ -z "$X_CONFFILE" ] && X_CONFFILE="${BUMBLEBEE_CONFDIR}/xorg.conf.${DRIVER}"

# -config file   use a certain xorg.conffile so the nvidia drivers can be used
# -sharevts      without this option, the current VTY running X becomes blank
#                while the Bumblebee X server is running
# -nolisten tcp  do not use start a TCP server listening for connections
# -noreset       do not logout after the last program closes
X_DAEMON_ARGS="-config $X_CONFFILE -sharevts -nolisten tcp -noreset"

# Remove colon and everything before it: :1.0 -> 1.0
display=${VGL_DISPLAY##*:}
# Remove dot and everything after it: 1.0 -> 0
display=${display%%.*}
PIDFILE="/tmp/.X${display}-lock"
X_LOG="/var/log/Xorg.${display}.log"

# allow to set X_LD_LIBRARY_PATH if needed
if [ -s "${BUMBLEBEE_LIBDIR}/drivers/${DRIVER}.options" ]; then
    . "${BUMBLEBEE_LIBDIR}/drivers/${DRIVER}.options"
fi


# Start Bumblebee's X server running on the nvidia card
# Return values:
# 0 - X server is available
# 1 - X server is not available
start_x() {
    # is a X server running?
    xserver_available "$PIDFILE" "$X_DAEMON" "$X_DAEMON_ARGS" >/dev/null
    case $? in
      0) # already started
        return 0
        ;;
      1) # not started, see below
        ;;
      2) # ignore pidfile, start X
        rm -rf "$PIDFILE"
        ;;
      3) # driver crash
        log_daemon_msg "Xorg was previously crashed by the nvidia driver on display $VGL_DISPLAY."
        log_daemon_msg "Reboot the machine if you want to use Bumblebee"
        return 1
        ;;
      4) # another X is running
        log_daemon_msg "Display $VGL_DISPLAY is already in use."
        log_daemon_msg "Consider changing \$VGL_DISPLAY in $BUMBLEBEE_CONFDIR/bumblebee.conf"
        return 1
        ;;
    esac

    LD_LIBRARY_PATH="$X_LD_LIBRARY_PATH" \
        "$X_DAEMON" "$X_DAEMON_ARGS $VGL_DISPLAY" &

    # wait for at most three seconds before the server has started
    local retries=0
    # wait until the PIDFILE has become available (X is started)
    while [ ! -s "$PIDFILE" -a $retries -lt 6 ]; do
        ((retries++))
        sleep .5
    done

    # fail if the X server is not running
    if ! xserver_available "$PIDFILE" "$X_DAEMON" "$X_DAEMON_ARGS"; then
        log_daemon_msg "The Bumblebee X Server failed to start. Please check $X_LOG"
        return 1
    fi

    # Everything is OK, X has started
    return 0
}

# Stop the running X server
stop_x() {
    :
}

start_daemon() {
    if (( EUID != 0 )); then
        echo "Must be run as root"
        return 1
    fi

    # XXX: remove existing file?

    if ! mkfifo --mode=640  "$BUMBLEBEE_FIFO"; then
        log_daemon_msg "Error: Cannot create fifo $BUMBLEBEE_FIFO for communication."
        return 1
    fi

    local command
    local pids
    while :; do
        # this is our "sleep" function, it waits for clients to give commands
        command=$(< "$BUMBLEBEE_FIFO")
        # space-separated list of optirun instances
        pids=$(pidof -x "${OPTIRUNS[@]}")

        if [[ ${command:0:5} == start ]]; then
            # only start if there are actually clients running
            if [ -n "$pids" ]; then
                start_x
            fi
        else
            # allow to quit X if there are no clients running or if the client
            # does not have child programs running. xlsclients did not work :(
            if [ -z "$pids" ] || ! ps --ppid "$pids" > /dev/null; then
                stop_x
            fi
        fi
    done
}

# Show the versioning info and Project URL.
show_version_msg() {
    cat <<EOF
Bumblebee version ${BUMBLEBEE_VERSION}

Licenced under GNU GPL v3, "Beer-ware License" and "Red Bull License"
as published by Martin Juhl.

More info at: https://github.com/Bumblebee-Project/Bumblebee
EOF
}

# Show help message on usage and arguments.
show_help_msg() {
    show_version_msg

    cat <<EOF
Usage:
    bumblebee [OPTIONS]
    OPTIONS
        -d          start bumblebee service as daemon. To start it
                    backgrounded use the handler with 'start' argument.
        --help      show this help message
        --version   show version number
EOF
}

case "$1" in
  --version)
    show_version_msg
    ;;
  --help)
    show_help_msg
    ;;
  -d)
    start_daemon
    ;;
  *)
    show_help_msg
    ;;
esac
