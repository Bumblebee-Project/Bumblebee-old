#!/bin/bash
# Copyright (C) 2011 Bumblebee Project
#
# This file is part of Bumblebee.
#
# Bumblebee is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Bumblebee is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Bumblebee.  If not, see <http://www.gnu.org/licenses/>.

install_step() {
    local stage
    [ -n "$2" ] && echo "== $2 =="
    for stage in "${SKIP_STAGES[@]}"; do
        if [[ $stage == "$1" ]]; then
            echo "(skipped)"
            return
        fi
    done

    # try a customized step first
    for stage in "$BUILDDIR/stages/$1" "stages/$1"; do
        # Only run a step if it exists
        if [ -f "$stage" ]; then
            . "$stage"
            break
        fi
    done
}

install_step detectoldversion

# definition of tools (like $LSPCI) as well as command options parsing and
# options like installation path. It's a special case as it needs to be able to
# access the commandline options, therefore do not use install_step
. stages/setvars

install_step checkprivileges

install_step builddir

install_step determinedistro

# optional distro-specific variables, like paths
install_step "$DISTRO/setvars"

install_step welcome

install_step "$DISTRO/checkdependencies" "Checking dependencies"

install_step uninstall "Removing previous version"

install_step detecthardware "Detecting hardware"

install_step buildfiles "Building files"

install_step copyfiles "Installing Bumblebee"
install_step "$DISTRO/copyfiles"

install_step createuninstaller "Creating uninstaller"

install_step configure "Configuring"
install_step "$DISTRO/configure"

install_step finish
