#!/bin/bash
install_step() {
    local stage
    [ -n "$2" ] && echo "== $2 =="
    # try a customized step first
    for stage in "$BUILDDIR/stages/$1" "stages/$1"; do
        # Only run a step if it exists
        if [ -f "$stage" ]; then
            . "$stage"
            break
        fi
    done
}

# definition of tools (like $LSPCI) as well as command options parsing and
# options like installation path. It's a special case as it needs to be able to
# access the commandline options, therefore do not use install_step
. stages/setvars

install_step checkprivileges

# Perhaps the below action must be included in a file too so it can be disabled
mkdir -p "$BUILDDIR/install-files" "$BUILDDIR/stages"

install_step determinedistro
echo "${DISTRO}-based distribution found"

# optional distro-specific variables, like paths
install_step "$DISTRO/setvars"

install_step welcome

install_step "$DISTRO/checkdependencies" "Checking dependencies"

install_step uninstall "Removing previous version"

install_step detecthardware "Detecting hardware"

install_step buildfiles "Building files"

install_step copyfiles "Installing Bumblebee"
install_step "$DISTRO/copyfiles"

install_step configure "Configuring"
install_step "$DISTRO/configure"

install_step finish
